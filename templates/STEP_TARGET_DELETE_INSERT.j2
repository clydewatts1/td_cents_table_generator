/*
# ===============================================================================
#                      PRIMARK
#
# ===============================================================================
# ===============================================================================
# File Name           : OLR1001.100.TRANS.sql
# Pattern             : {{ step.pattern }}
# Purpose             : Insertion in TRANS table
# Author              : TERADATA
# File Type           : SQL
# Creation Date       : {{step.build_date}}
# -------------------------------------------------------------------------------
# Change History :
# Ver  | Date        |  Modified By           |  Change Description
# -------------------------------------------------------------------------------
# Automatically generated by 10cents_table_generator
# 1.0  | {{step.build_date}} | TERADATA               |  INITIAL CODE
# Build Time {{ step.build_time }}
# 1.0  | {{step.build_date}} | TERADATA               |  INITIAL CODE
*/

BEGIN TRANSACTION
;
.IF ERRORCODE <> 0 THEN .QUIT 101

/* Lock target table */
LOCKING DW${INSTANCE}{{step.target_database}}.{{ step.target_table }} FOR WRITE
;
.IF ERRORCODE <> 0 THEN .QUIT 101


DELETE FROM DW${INSTANCE}{{step.target_database}}.{{ step.target_table }}
;

.IF ERRORCODE <> 0 THEN .QUIT 101

INSERT INTO DW${INSTANCE}{{step.target_database}}.{{ step.target_table }}
(
    {%- for column in mapping.mapping_columns%}
    {% if column.column_action not in ('mapping','ignore')%}{{ column.target_column_name }}{% endif %}{% if not loop.last %}, {%else%}, {% endif %}
    {%- endfor %}
    /* Control Columnts */
    eff_from_dt,
    eff_to_dt,
    del_ind,
    run_id,
    update_run_id,
    job_id,
    update_job_id
)
{% if step.file_present == True%}{{step.sql_statement}}{% endif %}
;
.IF ERRORCODE <> 0 THEN .QUIT 101

/* End of INSERT statement */
END TRANSACTION
;
.IF ERRORCODE <> 0 THEN .QUIT 101


{% if step.stats != None and step.stats != ''%}

/* Collect statistics for the table */
COLLECT STATISTICS {{step.stats}} ON DW${INSTANCE}{{step.target_database}}.{{ step.target_table }}
;
.IF ERRORCODE <> 0 THEN .QUIT 101

{% endif %}
/* End of step */
